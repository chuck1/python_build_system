src_dir    = {{ src_dir }}
inc_dir    = {{ inc_dir }}
build_dir  = {{ build_dir }}/dynamic
inc        = {{ inc_str }} 
define_str = {{ define_str }}
binary     = {{ binary_file }}
compiler_dir = {{ compiler_dir }}
master_config_dir = {{ master_config_dir }}
lib_long_str      = {{ lib_long_str }}
lib_link_str      = {{ lib_link_str }}
makefile          = {{ makefile }}
project_name      = {{ project_name }}
library_type      = dynamic

depend_file = $(build_dir)/.depend

CC = g++

include $(compiler_dir)/color.mk
include $(compiler_dir)/cpp_library.mk

.PHONY: all

all: $(binary)
	@bash -c "echo -e \"$(COLOR_BLUE)$(build_dir)$(COLOR_RESET)\""

CFLAGS = -std=c++0x -Wno-format-security

CARGS = $(inc) $(define_str) $(CFLAGS)

MAKEDEPEND = $(CC) -c $(CARGS) -MM $^ -MF $(build_dir)/depends/$*.cpp.d -MT $(build_dir)/objects/$*.cpp.o

include $(compiler_dir)/process.mk

$(obj): $(makefile)

$(obj): $(build_dir)/objects/%.cpp.o: $(src_dir)/%.cpp
	@bash -c "echo -e \"$(COLOR_BLUE)build $@$(COLOR_RESET)\""
	@mkdir -p $(dir $@)
	@$(MAKEDEPEND)
	@g++ -fPIC -c $(CARGS) -o $@ $<

$(obj_processed): $(build_dir)/objects/%.cpp.o: $(build_dir)/processed/src/%.cpp
	@bash -c "echo -e \"$(COLOR_BLUE)build $@$(COLOR_RESET)\""
	@mkdir -p $(dir $@)
	@$(MAKEDEPEND)
	@g++ -fPIC -c $(CARGS) -o $@ $<

link_arg = -Wl,-whole-archive $(lib_link_str) -Wl,-no-whole-archive

$(binary_file): $(lib_long_str)

$(binary): $(obj)
	@bash -c "echo -e \"$(COLOR_BLUE)build $@$(COLOR_RESET)\""
	@$(CC) -shared $(link_arg) -Wl,-soname,$@.1 -o $@.1.0 $^
	@ln -sf $@.1.0 $@.1
	@ln -sf $@.1.0 $@

clean:
	rm -rf $(build_dir)/*

include $(compiler_dir)/depend.mk
include $(compiler_dir)/help.mk


